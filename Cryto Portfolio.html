<!DOCTYPE html>
<html lang="en">
<head>
<style>
    img {
        width: 20px;
        height: 20px;
    }
</style>
  <title>Crypto Investments Live Tracker</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
</head>
<body>
<br>
<div class="container">
 
    <h1>Crypto Portfolio</h1>
    <p>This widget allows users to centrally document and track cryptocurrency investments.</p>
    <div class="row">
    <button type="button" class="btn btn-success" data-toggle="collapse" data-target="#defport">Define Portfolio</button>
    </div>
    <div id="defport" class="collapse">
        <br>
        <form>
        <div class="row">
        <div class="form-group col-sm-2">
        <select onchange="defaultPrices()" name= "currency" id="currency" placeholder="Id" class="chosen-select form-control"></select>
        </div>
        <div class="form-group col-sm-2">
        <input class="form-control" type="text" id="Quantity" placeholder="Quantity">
        </div>
        <div class="form-group col-sm-2">
        <input class="form-control" type="text" id="priceusd" placeholder="Price(USD)">
        </div>
        <div class="form-group col-sm-2">
        <input class="form-control" type="text" id="pricebtc" placeholder="Price(BTC)">
        </div>
        <div class="form-group col-sm-2">
    	<input type="button" class="btn btn-dark add-row form-control" value="Add Row">
        </div>
        </div>
        </form>
    <table id="dptable" class="table">
        <thead>
            <tr>
                <th>Select</th>
                <th>Name</th>
                <th>Quantity</th>
                <th>Price(USD)</th>
                <th>Price(BTC)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="checkbox" name="record"></td>
                <td><img class = "img-rounded" src="https://s2.coinmarketcap.com/static/img/coins/64x64/1723.png"><span class="dpid"> SONM</span></td>
                <td><span class="dpqty">1000</span></td>
                <td><span class="dppriceusd">0.12</span></td>
                <td><span class="dppricebtc">0.00002300</span></td>
            </tr>
        </tbody>
    </table>
    <button type="button" class="btn btn-danger delete-row">Delete Row</button>
    </div>
    <br/>
    <div class="row">
     <button type="button" class="btn btn-success psdata" data-toggle="collapse" data-target="#portsummary">Investments Summary</button>
    </div>
    <div id="portsummary" class="collapse">
        <br>
        <table id="pstable" class="table">
        <thead>
            <tr>
                <th style="width:41.5%">Name</th>
                <th>Quantity</th>
                <th>Value(USD)</th>
                <th>Value(BTC)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>SONM</td>
                <td>1000</td>
                <td>576.23</td>
                <td>.15602300</td>
            </tr>
        </tbody>
    </table>
    </div>
    <br/>
    <div class="row">
     <button type="button" class="btn btn-success csdata" data-toggle="collapse" data-target="#currstat">Investments Status</button>
    </div>
    <div id="currstat" class="collapse">
        <br>
        <p>This section refreshes automatically after every one minute...</p>
        <table id="currstattable" class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Market Cap</th>
                <th>Price</th>
                <th>Volume(24h)</th>
                <th>&Delta;(1h)</th>
                <th>&Delta;(24h)</th>
                <th>&Delta;(7d)</th>
                <th>Profile(USD)</th>
                <th>Profile(BTC)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>SONM</td>
                <td>1000</td>
                <td>576.23</td>
                <td>.15602300</td>
            </tr>
        </tbody>
    </table>
    <br><br><br><br><br>
    <div class="row">
     <button type="button" class="btn btn-dark float-right" data-toggle="collapse" data-target="#donate">Buy me a cup of coffee</button>
    </div>
    <div id="donate" class="collapse">
        <br>
        <div class="card">
        <div class="card-body">
          <h4 class="card-title">Note from developer[Karthik D]:</h4>
          <p class="card-text">Thank you for your contribution. Knowing that my efforts have had a positive impact on the community, gives me the motivation to make more quality content for free. Cheers!!! </p>
          <p style="" class="card-text">BTC Address: 35UoAHkqDA493nuFaArFcWNf56ZPUJ8ppd <br /> MEW Address: 0xFC5479343d791eca8EEBB01C488e0a5F460f0453</p>
        </div>
    </div>
    </div>
    </div>
</div>
<footer>
</footer>
</body>
<script>
    var gv_symbols={},gv_symbols1={};
    
        $(document).ready(function(){
        
        getallsymbols();    
        //defaultPrices();
        $(".add-row").click(function(){
            var id = $("#currency option:selected").text();
            var idv = gv_symbols1[$('#currency option:selected').val()]["id"];
            var quantity = $("#Quantity").val();
            var priceusd = $("#priceusd").val();
            var pricebtc = $("#pricebtc").val();
            var markup = "<tr><td><input type='checkbox' name='record'></td><td>" + '<img class = "img-rounded" src="https://s2.coinmarketcap.com/static/img/coins/64x64/' + idv + '.png">' + '<span class="dpid"> ' + id + '</span></td><td><span class="dpqty">' + quantity + '</span></td><td><span class="dppriceusd">' + priceusd + '</span></td><td><span class="dppricebtc">' + pricebtc + "</span></td></tr>";
            $("#dptable tbody").append(markup);
        });
        
        // Find and remove selected table rows
        $(".delete-row").click(function(){
            $("#dptable tbody").find('input[name="record"]').each(function(){
            	if($(this).is(":checked")){
                    $(this).parents("tr").remove();
                }
            });
        });
        
        //Porfolio Summary Table Update
        $(".psdata, .add-row, .delete-row").click(function(){
            var coin_img = [];
            var coin_name = [];
            var coin_qty = [];
            var coin_valusd = [];
            var coin_valbtc = [];
            $('#dptable > tbody > tr').each(function () {
            var dpimgsrc = $(this).find('img').attr('src');
            var dpid = $(this).find('.dpid').text();
            var dpqty = parseFloat($(this).find('.dpqty').text());
            var dppriceusd = parseFloat($(this).find('.dppriceusd').text());
            var dppricebtc = parseFloat($(this).find('.dppricebtc').text());
            // Summarizing based on coin name
            if(coin_name.length < 1){
               coin_img.push(dpimgsrc);
               coin_name.push(dpid);
               coin_qty.push(dpqty);
               coin_valusd.push(dppriceusd*dpqty);
               coin_valbtc.push(dppricebtc*dpqty);
               }
            else{
                function dpidindx(x){
                    return x === dpid;
                }
                
                if(coin_name.findIndex(dpidindx) === -1 ){
                   coin_img.push(dpimgsrc);
                   coin_name.push(dpid);
                   coin_qty.push(dpqty);
                   coin_valusd.push(dppriceusd*dpqty);
                   coin_valbtc.push(dppricebtc*dpqty);
                   }
                else{
                    var i1 = coin_name.findIndex(dpidindx);
                    coin_qty[i1] += dpqty; 
                    coin_valusd[i1] += dppriceusd*dpqty; 
                    coin_valbtc[i1] += dppricebtc*dpqty; 
                }
            }
        });
            var portsummary = '';
            //End code
            for(i=0;i<coin_name.length;i++) {
                portsummary += '<tr><td><img class = "img-rounded" src="'+ coin_img[i] + '"> ' + coin_name[i] + '</td><td>' + coin_qty[i] + '</td><td>' + coin_valusd[i] + '</td><td>' + coin_valbtc[i] + '</td></tr>';
            }
            //Delete existing rows
            $("#pstable tbody tr").each(function(){
                        $(this).remove();
                });
            //Add new Markup
            $("#pstable tbody").append(portsummary);
        });
    });
    
    //Current Status Table Populate
    $(".csdata").click(function(){
        updateCurrentStat();
    });
    
    //Autofil Prices to default.
    function defaultPrices(){
        var idv = $("#currency option:selected").val();
        var ourRequest = new XMLHttpRequest();
        ourRequest.open('GET','https://api.coinmarketcap.com/v1/ticker/'+ idv + '/',true);
                ourRequest.onload = function (){
                    var ourData = JSON.parse(ourRequest.responseText);
                    document.getElementById('priceusd').value = ourData[0].price_usd;
                    document.getElementById('pricebtc').value = ourData[0].price_btc;
                }
                ourRequest.send();
    }
                
    
    //Run updateCurrentStat(); function every 2 mins;
    
    function refresh_stat(){
        updateCurrentStat();
        setTimeout(refresh_stat, 60000);
    }
    
    setTimeout(refresh_stat,2000);
    
    //Get Symbols from CoinMarketCap
    function getallsymbols(){
        //BITCOIN PRICE REST API
            var ourRequest1 = new XMLHttpRequest();
            var url = 'https://api.coinmarketcap.com/v2/listings/';
            ourRequest1.open('GET',url,true);
            ourRequest1.onload = function (){  
                ourDatax = JSON.parse(ourRequest1.responseText);
                ourData = ourDatax["data"];
                //gv_symbols = gv_symbols.concat(ourData);
                var optionsAsString = '';
                //document.getElementById('currentprice').value = ourData[0]["price"];
                for (i=0;i<ourData.length;i++){
                    optionsAsString += "<option value='" + ourData[i]["website_slug"] + "'>" + ourData[i]["name"] + "</option>";
                    gv_symbols[ourData[i]["id"]] = ourData[i];
                    gv_symbols1[ourData[i]["website_slug"]] = ourData[i];
                }    
                $('select[name="currency"]' ).append( optionsAsString );
                defaultPrices();
            }
            ourRequest1.send();
    }  
    
    
    function updateCurrentStat(){
            var coin_img = [];
            var coin_name = [];
            var coin_qty = [];
            var coin_valusd = [];
            var coin_valbtc = [];
            $('#dptable > tbody > tr').each(function () {
            var dpimgsrc = $(this).find('img').attr('src');
            var dpid = $(this).find('.dpid').text();
            var dpqty = parseFloat($(this).find('.dpqty').text());
            var dppriceusd = parseFloat($(this).find('.dppriceusd').text());
            var dppricebtc = parseFloat($(this).find('.dppricebtc').text());
            // Summarizing based on coin name
            if(coin_name.length < 1){
               coin_img.push(dpimgsrc);
               coin_name.push(dpid);
               coin_qty.push(dpqty);
               coin_valusd.push(dppriceusd*dpqty);
               coin_valbtc.push(dppricebtc*dpqty);
               }
            else{
                function dpidindx(x){
                    return x === dpid;
                }
                
                if(coin_name.findIndex(dpidindx) === -1 ){
                   coin_img.push(dpimgsrc);
                   coin_name.push(dpid);
                   coin_qty.push(dpqty);
                   coin_valusd.push(dppriceusd*dpqty);
                   coin_valbtc.push(dppricebtc*dpqty);
                   }
                else{
                    var i1 = coin_name.findIndex(dpidindx);
                    coin_qty[i1] += dpqty; 
                    coin_valusd[i1] += dppriceusd*dpqty; 
                    coin_valbtc[i1] += dppricebtc*dpqty; 
                }
            }
        });
            var portsummary = '';
            //End code
            for(i=0;i<coin_name.length;i++) {
                
                //Get API from CoinMarketCap
                var res1 = [];
                var res2 = [];
                var cur_mc;
                var cur_pu;
                var cur_pb;
                var cur_v24h;
                var cur_c24h;
                var cur_c1hr;
                var cur_c7d;
                res1 = coin_img[i].split("/");
                res2 = res1[7].split(".");
                var ourRequest = new XMLHttpRequest();
                ourRequest.open('GET','https://api.coinmarketcap.com/v1/ticker/'+ gv_symbols[res2[0]]["website_slug"] + '/',false);
                //ourRequest.open('GET','https://api.coinmarketcap.com/v1/ticker/sonm/',false);
                ourRequest.onload = function (){
                    var ourData = JSON.parse(ourRequest.responseText);
                    cur_mc = abbrNum(parseInt(ourData[0].market_cap_usd),2) + ' USD';
                    cur_pu = parseFloat(ourData[0].price_usd);
                    cur_pb = parseFloat(ourData[0].price_btc);
                    cur_v24h = abbrNum(parseFloat(ourData[0]["24h_volume_usd"]),2) + ' USD';
                    cur_c24h = parseFloat(ourData[0].percent_change_24h);
                    cur_c1hr = parseFloat(ourData[0].percent_change_1h);
                    cur_7d = parseFloat(ourData[0].percent_change_7d);
                    
                    var cur_statusd = coin_qty[i]*cur_pu;
                    var delta_usd = (coin_qty[i]*cur_pu - coin_valusd[i])*100/coin_valusd[i];
                    var cur_statbtc = coin_qty[i]*cur_pb;
                    var delta_btc = (coin_qty[i]*cur_pb - coin_valbtc[i])*100/coin_valbtc[i];
                    //var stat_usd = '$' + cur_statusd.toString();

                    portsummary += '<tr><td style="text-align:center"><img style="width:40px;height:40px" class = "img-rounded" src="'+ coin_img[i] + '"><br><a href="https://coinmarketcap.com/currencies/' + res2[0] + '/" target="_blank" >' + coin_name[i] + '</a></td><td>' + cur_mc + '</td><td>' + cur_pu.toFixed(4).toString() + ' USD' + '</td><td>' + cur_v24h + '</td>';
                    if(cur_c1hr < 0){
                       portsummary += '<td style="color:red">' + cur_c1hr + '%</td>';
                       }
                    else{
                       portsummary += '<td style="color:green">' + cur_c1hr + '%</td>';
                    }
                    if(cur_c24h < 0){
                       portsummary += '<td style="color:red">' + cur_c24h + '%</td>';
                       }
                    else{
                       portsummary += '<td style="color:green">' + cur_c24h + '%</td>';
                    }
                    if(cur_7d < 0){
                       portsummary += '<td style="color:red">' + cur_7d + '%</td>';
                       }
                    else{
                       portsummary += '<td style="color:green">' + cur_7d + '%</td>';
                    }
                    
                    portsummary += '<td>$' + cur_statusd.toFixed(2).toString();
                    
                    if(delta_usd < 0){
                        portsummary += '<p style="color:red">(' + delta_usd.toFixed(2).toString() + '%)' + '</td>'; 
                       }
                    else{
                        portsummary += '<p style="color:green">(' + delta_usd.toFixed(2).toString() + '%)' + '</td>';
                    }
                    portsummary += '<td>' + cur_statbtc.toFixed(8).toString() + ' BTC';
                    if(delta_btc < 0){
                        portsummary += '<p style="color:red">(' + delta_btc.toFixed(2).toString() + '%)' + '</td>'; 
                       }
                    else{
                        portsummary += '<p style="color:green">(' + delta_btc.toFixed(2).toString() + '%)' + '</td></tr>';
                    }
                    
                    //Delete existing rows
                    $("#currstattable tbody tr").each(function(){
                                $(this).remove();
                        });
                    //Add new Markup
                    $("#currstattable tbody").append(portsummary);
                    }
                    ourRequest.send();
            //}); 
                }
    }
    
    //Round Numbers to make it readable.
    function abbrNum(number, decPlaces) {
    // 2 decimal places => 100, 3 => 1000, etc
    decPlaces = Math.pow(10,decPlaces);

    // Enumerate number abbreviations
    var abbrev = [ "K", "M", "B", "T" ];

    // Go through the array backwards, so we do the largest first
    for (var i=abbrev.length-1; i>=0; i--) {

        // Convert array index to "1000", "1000000", etc
        var size = Math.pow(10,(i+1)*3);

        // If the number is bigger or equal do the abbreviation
        if(size <= number) {
             // Here, we multiply by decPlaces, round, and then divide by decPlaces.
             // This gives us nice rounding to a particular decimal place.
             number = Math.round(number*decPlaces/size)/decPlaces;

             // Handle special case where we round up to the next abbreviation
             if((number == 1000) && (i < abbrev.length - 1)) {
                 number = 1;
                 i++;
             }

             // Add the letter for the abbreviation
             number += abbrev[i];

             // We are done... stop
             break;
        }
    }

    return number;
}
</script>
</html>
